<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
      /* --- 1. REGLA DE ORO (CORRECCI√ìN DE DESBORDE) --- */
      * {
        box-sizing: border-box; /* Esto evita que el padding agrande las cajas */
      }

      /* --- 2. ESTILOS BASE --- */
      body { 
        font-family: 'Poppins', sans-serif; 
        background-color: #f0f2f5; 
        margin: 0;
        padding: 0;
        color: #333;
        padding-bottom: 100px;
      }
      
      .container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        background: #f0f2f5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden; /* Evita scroll horizontal indeseado */
      }

      /* --- 3. TARJETAS --- */
      .card-section {
        background: white;
        border-radius: 16px;
        padding: 20px 15px;
        margin: 10px 10px 0 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        text-align: center;
        position: relative;
      }
      
      /* --- 4. ENCABEZADO --- */
      .header {
        text-align: center;
        padding: 30px 20px 40px 20px;
        background: linear-gradient(180deg, #051e11 0%, #0a3d24 100%);
        border-radius: 0 0 30px 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        margin-bottom: 20px;
        color: white;
      }
      
      .logo-img { max-width: 180px; height: auto; display: block; margin: 0 auto 10px auto; }

      .legal-box {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 8px 12px;
        margin: 0 auto;
        display: inline-block;
        font-size: 10px;
        line-height: 1.4;
        color: #e0e0e0;
        text-align: left;
      }

      /* --- 5. PRECIOS Y TEXTOS --- */
      .fecha-sorteo {
        background-color: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9;
        padding: 6px 16px; border-radius: 50px; font-size: 12px; font-weight: 700;
        margin-top: -30px; margin-bottom: 10px; display: inline-block;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .loteria-name { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; margin-bottom: 5px; }
      .premio-mayor { font-size: 38px; font-weight: 800; color: #1b5e20; margin: 0; line-height: 1.1; letter-spacing: -1px; }

      .price-tag {
        background: #128C7E; color: white; padding: 12px; border-radius: 50px; 
        font-size: 16px; font-weight: bold; margin: 20px 20px 10px 20px; 
        text-align: center; box-shadow: 0 4px 12px rgba(18, 140, 126, 0.25);
      }

      /* --- 6. PASOS --- */
      .steps-container { padding: 20px; }
      .step-title { font-size: 14px; font-weight: 700; margin-bottom: 15px; text-align: center; color: #aaa; text-transform: uppercase; }
      .steps-grid { display: flex; justify-content: space-around; gap: 10px; }
      .step-box { text-align: center; font-size: 11px; color: #555; position: relative; }
      .step-box::after { content: '‚Üí'; position: absolute; right: -15px; top: 10px; color: #ddd; font-size: 14px; }
      .step-box:last-child::after { content: ''; }
      .step-icon { font-size: 22px; display: block; margin-bottom: 5px; background: #fff; width: 40px; height: 40px; line-height: 40px; border-radius: 50%; margin: 0 auto 5px auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

      /* --- 7. GRID DE N√öMEROS (CORREGIDO) --- */
      .numbers-section { padding: 10px; }
      
      .grid-container {
        display: grid;
        /* En celular: 4 columnas */
        grid-template-columns: repeat(4, 1fr); 
        gap: 8px;
        width: 100%; /* Asegura que no se salga */
      }

      .btn-numero {
        aspect-ratio: 1;
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        font-size: 14px; /* Ajustado para que quepa bien */
        font-family: 'Poppins', sans-serif;
        font-weight: 700;
        color: #333;
        cursor: pointer;
        transition: transform 0.1s;
        display: flex;
        flex-direction: column; 
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        overflow: hidden; /* Evita que nombres largos rompan el bot√≥n */
        word-break: break-all;
      }
      
      .btn-numero:active { transform: scale(0.95); background: #f5f5f5; }
      
      .info-mini { font-size: 8px; color: #666; font-weight: 400; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }

      .seleccionado {
        background-color: #ff9800 !important; color: white !important; 
        border: 1px solid #f57c00 !important; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3) !important;
        transform: scale(1.02);
      }
      .ocupado { background-color: #eeeeee; color: #bdbdbd; border-color: transparent; cursor: not-allowed; opacity: 0.8; }
      .disponible { color: #1b5e20; }

      /* --- 8. BARRA FLOTANTE Y MODAL --- */
      .bottom-bar {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 1px solid #eee;
        padding: 12px 20px; display: none; justify-content: space-between; align-items: center;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 900;
      }
      .btn-pagar-float {
        background-color: #1b5e20; color: white; padding: 12px 30px;
        border: none; border-radius: 50px; font-weight: 700; font-size: 15px;
        box-shadow: 0 4px 10px rgba(27, 94, 32, 0.2); cursor: pointer;
      }
      .resumen-total { font-size: 18px; font-weight: 800; color: #1b5e20; }
      .resumen-compra { font-size: 13px; color: #666; display: flex; flex-direction: column;}

      .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        display: none; justify-content: center; align-items: center; z-index: 1000;
      }
      .modal-content {
        background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 340px;
      }
      .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #f9f9f9; outline: none; margin-bottom: 15px;}
      .input-group label { font-weight: 600; font-size: 12px; color: #555; margin-bottom: 5px; display: block;}
      .btn-confirmar { width: 100%; padding: 14px; background: #1b5e20; color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer;}
      .btn-cancelar { width: 100%; padding: 10px; background: transparent; color: #777; border: none; font-weight: 600; cursor: pointer; margin-top: 5px;}
      
      .prize-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
      .prize-item:last-child { border-bottom: none; }
      .prize-value { font-weight: 700; color: #333; }
      .rule-box { background: #f1f8e9; border-left: 3px solid #4caf50; padding: 10px; font-size: 11px; color: #33691e; text-align: left; margin-top: 15px; border-radius: 4px;}
      .secondary-prizes { margin: 0; padding: 0; }

      /* --- 9. VERSI√ìN COMPUTADOR (RESPONSIVE CORREGIDO) --- */
      @media (min-width: 768px) {
        .container {
          max-width: 900px;
          margin: 30px auto;
          border-radius: 20px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.1);
          overflow: hidden; /* Esto mantiene todo dentro de la tarjeta */
          min-height: auto;
        }
        
        .grid-container {
          /* En computador mostramos 10 columnas para que sea vea ordenado (0-9) */
          grid-template-columns: repeat(10, 1fr); 
          gap: 10px;
          padding: 20px;
        }
        
        .btn-numero {
          font-size: 14px;
        }

        .header { border-radius: 0; }
      }

      /* --- ESTILOS OR√ÅCULO IA (PEGAR AL FINAL DEL CSS) --- */
      .card-oracle {
        background: linear-gradient(135deg, #f0f4ff 0%, #e6eeff 100%);
        border: 1px solid #d0dfff;
        margin-top: 15px; /* Separaci√≥n con la tabla de premios */
      }
      .btn-ai-oracle {
        background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
        color: white; border: none; padding: 12px 24px; border-radius: 50px;
        font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3);
        transition: transform 0.2s; font-size: 14px; margin: 0 auto;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        font-family: 'Poppins', sans-serif;
      }
      .btn-ai-oracle:hover { transform: scale(1.05); }
      .btn-ai-oracle:disabled { opacity: 0.7; cursor: wait; }

      /* Modal Or√°culo */
      .oracle-textarea {
        width: 100%; padding: 12px; border: 1px solid #aecbfa; border-radius: 12px;
        font-size: 14px; background: #fff; outline: none; font-family: 'Poppins', sans-serif; resize: none;
        box-sizing: border-box; margin-bottom: 10px;
      }
      .oracle-result-box {
        margin-top: 15px; padding: 15px; background: #f8faff; border-radius: 12px;
        border: 1px dashed #aecbfa; display: none;
      }
      .oracle-numbers { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px; }
      .btn-oracle-num {
        background: #fff; border: 2px solid #2575fc; color: #2575fc;
        font-weight: 800; padding: 8px 15px; border-radius: 12px; cursor: pointer;
        transition: all 0.2s;
      }
      .btn-oracle-num:hover { background: #2575fc; color: white; }
      .typing-indicator::after { content: '...'; animation: typing 1s infinite; }
      @keyframes typing { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }

    </style>
  </head>
  <body>

    <div class="container">
      
      <div class="header">
        <img src="https://losplata.s3.us-east-2.amazonaws.com/Logo.png" alt="Los Plata" class="logo-img">
        
        <div class="legal-box">
          <strong>LOS PLATA S.A.S.</strong>
          NIT: 902.003.134<br>
          Rep. Legal: Mateo Plata Buitrago<br>
          Cra 6 #12-04 Local 2, Chinchin√° - Caldas
        </div>
      </div>

      <div class="hero-section">
        
        <div class="card-section" style="margin-top: -20px; z-index: 10;">
          <div class="fecha-sorteo" style="margin-top: -35px; background: white; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.08);">
            üìÖ Juega el 10 de Febrero
          </div>

          <div class="loteria-name" style="margin-top: 10px;">Loter√≠a Chontico d√≠a</div>
          <h1 class="premio-mayor" style="font-size: 48px; margin: 5px 0 10px 0;">$800.000</h1>
          <div style="font-size: 13px; color: #1b5e20; font-weight: 600; background: #e8f5e9; display: inline-block; padding: 4px 12px; border-radius: 8px;">
            ‚ú® ¬°3 Oportunidades de Ganar! ‚ú®
          </div>
        </div>

        <div class="card-section">
          <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px;">
            üìã Tabla de Premios
          </h3>

          <div class="secondary-prizes">
            <div class="prize-item">
              <span class="prize-label">üèÜ √öltimas 3 cifras</span>
              <span class="prize-value">$800.000</span>
            </div>
            <div class="prize-item">
              <span class="prize-label">üèÜ Primeras 3 cifras</span>
              <span class="prize-value">$800.000</span>
            </div>
            <div class="prize-item">
              <span class="prize-label">üèÜ 3 Cifras del medio</span>
              <span class="prize-value">$800.000</span>
            </div>
          </div>

        </div>

        <div class="card-section card-oracle">
          <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #3366cc; text-transform: uppercase;">
            ‚ú® ¬øNo sabes qu√© jugar?
          </h3>
          <p style="font-size:12px; color:#555; margin-bottom:15px;">
            Cu√©ntame tu sue√±o y la IA te dar√° tu n√∫mero de la suerte.
          </p>
          <button class="btn-ai-oracle" onclick="abrirOraculo()">
            <span>üîÆ</span> Preguntar al Or√°culo
          </button>
        </div>

      </div>

      <div class="price-tag">
        üî• PROMO: 3 Boletas por $15.000
      </div>

      <div class="steps-container">
        <div class="step-title">Pasos para jugar</div>
        <div class="steps-grid">
          <div class="step-box">
            <span class="step-icon">üëÜ</span>
            <strong>Escoge</strong><br>tu n√∫mero
          </div>
          <div class="step-box">
            <span class="step-icon">‚úçÔ∏è</span>
            <strong>Llena</strong><br>tus datos
          </div>
          <div class="step-box">
            <span class="step-icon">üí¨</span>
            <strong>WhatsApp</strong><br>para pagar
          </div>
        </div>
      </div>

      <div class="numbers-section">
        
        <div style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px;">
          
          <input type="number" id="input-busqueda" placeholder="üîç Buscar n√∫mero espec√≠fico..." 
                 oninput="filtrarNumeros()" 
                 style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; text-align: center; outline: none; transition: 0.3s;">
          
          <label style="display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; color: #555; cursor: pointer; background: white; padding: 10px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
            <input type="checkbox" id="chk-disponibles" onchange="filtrarNumeros()" style="width: 18px; height: 18px; accent-color: #1b5e20;" checked>
            <span>üü¢ Mostrar solo n√∫meros disponibles</span>
          </label>

        </div>
        
        <div id="loading" style="text-align:center; color:#999; padding:20px;">Cargando boletas...</div>
        <div id="grid" class="grid-container"></div>
      </div>

    </div>

    <div id="bottom-bar" class="bottom-bar">
      <div class="resumen-compra">
        <span id="qty-text">0 boletas</span>
        <span id="total-text" class="resumen-total">$0</span>
      </div>
      <button class="btn-pagar-float" onclick="abrirModal()">Comprar</button>
    </div>

    <div id="modal" class="modal-overlay">
      <div class="modal-content">
        <h3 style="text-align:center; margin-top:0; color:#333;">Reservar: <span id="num-modal" style="font-size: 24px; color:#1b5e20;"></span></h3>
        <p style="text-align:center; color:#666; font-size:13px; margin-bottom:25px;">Ingresa tus datos para apartar:</p>
        
        <div class="input-group">
          <label>Nombre Completo</label>
          <input type="text" id="input-nombre" placeholder="Tu nombre aqu√≠">
        </div>
        
        <div class="input-group">
          <label>Celular / WhatsApp</label>
          <input type="tel" id="input-telefono" placeholder="Ej: 3001234567" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>

        <button class="btn-confirmar" onclick="confirmarReserva()">Confirmar Reserva</button>
        <button class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
        
        <div id="msg-carga" class="loader">
          üîÑ Guardando...<br>
          <span style="font-size:12px; font-weight:normal; color:#666;">Te enviaremos a WhatsApp enseguida</span>
        </div>
      </div>
      
       <div id="modal-soldout" class="modal-overlay">

        <div id="modal-oracle" class="modal-overlay">
      <div class="modal-content" style="background: linear-gradient(135deg, #fff 0%, #f4f8ff 100%);">
        <div style="text-align:center; margin-bottom:15px;">
           <span style="font-size:40px;">üîÆ</span>
        </div>
        <h3 style="text-align:center; margin-top:0; color:#3366cc;">Or√°culo de la Suerte</h3>
        <p style="text-align:center; color:#555; font-size:13px; margin-bottom:20px;">
          ¬øQu√© so√±aste anoche o qu√© se√±al viste hoy?
        </p>
        
        <textarea id="input-oracle-text" rows="3" placeholder="Ej: So√±√© con un gato negro..." class="oracle-textarea"></textarea>

        <button id="btn-ask-oracle" class="btn-ai-oracle" style="width:100%;" onclick="consultarGemini()">
          ‚ú® Interpretar Se√±ales
        </button>
        
        <div id="oracle-result" class="oracle-result-box">
          <p id="oracle-msg" style="font-size:12px; color:#333; font-style:italic; text-align:center; margin:0 0 10px 0;">...</p>
          <div id="oracle-suggestions" class="oracle-numbers"></div>
        </div>

        <button class="btn-cancelar" onclick="cerrarOraculo()">Cerrar</button>
      </div>
    </div>

      <div class="modal-content" style="text-align:center;">
        <h2 style="color:#d32f2f; margin-top:0; font-size: 24px;">üö´ ¬°SOLD OUT! üö´</h2>
        <h3 style="color:#333;">SE ACABARON</h3>
        
        <p style="font-size:15px; color:#555; line-height: 1.6;">
          ¬°Hoy arrasaron con todo! üò±<br>
          Muchas gracias por el apoyo.
        </p>
        
        <p style="font-size:15px; color:#1b5e20; font-weight:bold;">
          Ma√±ana volvemos con m√°s suerte y nuevos n√∫meros.<br>
          ¬°Atentos al grupo!
        </p>

        <button class="btn-confirmar" onclick="cerrarSoldOut()">Aceptar</button>
      </div>
    </div>

    </div>

    <script>
    const PRECIO_BOLETA = 5000;
    let numerosSeleccionados = [];
    let muestraInicial = []; // <--- NUEVA VARIABLE

    // --- NUEVA FUNCI√ìN: ELIGE 10 N√öMEROS AL AZAR POR CADA SERIE ---
    function generarMuestra(datos) {
      let grupos = {0:[], 1:[], 2:[], 3:[], 4:[], 5:[], 6:[], 7:[], 8:[], 9:[]};
      
      // 1. Clasificamos los n√∫meros DISPONIBLES por su primer d√≠gito
      datos.forEach(fila => {
        let num = String(fila[0]).trim();
        let estado = String(fila[1]).trim();
        
        if (estado === 'Disponible') {
          // Si el n√∫mero es '005', el primer d√≠gito es '0'. Si es '150', es '1'.
          // Aseguramos que tenga 3 d√≠gitos (rellenando con ceros a la izquierda si hace falta)
          let numNormalizado = num.padStart(3, '0');
          let primerDigito = numNormalizado.charAt(0);
          
          if (grupos[primerDigito]) {
            grupos[primerDigito].push(num);
          }
        }
      });

      // 2. Elegimos 10 al azar de cada grupo
      muestraInicial = [];
      for (let i = 0; i <= 9; i++) {
        let serie = grupos[i];
        // Barajamos (Shuffle) la serie
        serie.sort(() => 0.5 - Math.random());
        // Tomamos los primeros 10 (o menos si no hay tantos)
        let seleccion = serie.slice(0, 10);
        muestraInicial = muestraInicial.concat(seleccion);
      }
      console.log("Muestra generada:", muestraInicial.length, "n√∫meros.");
    }

      window.onload = function() {
        google.script.run
          .withSuccessHandler(pintarNumeros) // Si todo sale bien
          .withFailureHandler(function(error) { // Si algo sale mal
             document.getElementById('loading').innerHTML = 
               `<div style="color:red; font-weight:bold; padding:20px; border:2px solid red; border-radius:10px; background:#fff;">
                  ‚ò†Ô∏è ERROR GRAVE:<br>${error.message}
                </div>`;
          })
          .obtenerDatos();
      };

      function pintarNumeros(datos) {
        generarMuestra(datos); // <--- ¬°AGREGA ESTA L√çNEA AQU√ç!
        
        const contenedor = document.getElementById('grid');
        // ... (el resto de tu funci√≥n sigue EXACTAMENTE IGUAL) ...
        document.getElementById('loading').style.display = 'none';
        contenedor.innerHTML = ""; 
        
        let contadorDisponibles = 0;

        datos.forEach(fila => {
          const numero = fila[0];
          const estado = String(fila[1]).trim(); 
          const nombreCliente = fila[2] || "An√≥nimo"; 
          const telCliente = String(fila[3] || "");
          
          if (estado === 'Disponible' && String(numero).trim() !== "") {
           contadorDisponibles++;
          }

          const telOculto = telCliente.length > 4 
            ? "Tel:.." + telCliente.slice(-4) 
            : telCliente;

          const btn = document.createElement('button');
          btn.id = 'btn-' + numero;
          btn.className = 'btn-numero ' + (estado === 'Disponible' ? 'disponible' : 'ocupado');

          if (estado === 'Disponible') {
            btn.innerText = numero;
            btn.onclick = function() { toggleSeleccion(numero, btn) };
            btn.title = "Clic para seleccionar";
          } else {
            btn.innerHTML = `
              <span style="font-size:18px; color:#888; font-weight:700;">${numero}</span>
              <span class="info-mini" style="font-weight:bold; color:#333;">${nombreCliente}</span>
              <span class="info-mini" style="color:#666;">${telOculto}</span>
            `;
            btn.onclick = null; 
            btn.style.cursor = "default";
          }
          
          contenedor.appendChild(btn);
        });
        
         if (contadorDisponibles === 0) {
          document.getElementById('modal-soldout').style.display = 'flex';
        }

        // --- NUEVO: ESTO APLICA EL FILTRO INMEDIATAMENTE AL CARGAR ---
        filtrarNumeros(); 
      }

      // --- FUNCI√ìN DE FILTRADO INTELIGENTE (Vitrina vs B√∫squeda) ---
      function filtrarNumeros() {
        const busqueda = document.getElementById('input-busqueda').value.trim();
        const chk = document.getElementById('chk-disponibles');
        const soloDisponibles = chk ? chk.checked : false;
        
        const grid = document.getElementById('grid');
        const botones = grid.getElementsByClassName('btn-numero');

        const modoVitrina = (busqueda === ""); // ¬øEl buscador est√° vac√≠o?

        for (let btn of botones) {
          const numeroDelBoton = btn.id.replace('btn-', '');
          const esDisponible = btn.classList.contains('disponible');
          
          let mostrar = false;

          if (modoVitrina) {
            // MODO 1: VITRINA (Cliente acaba de entrar)
            const estaEnMuestra = muestraInicial.includes(numeroDelBoton);
            
            if (soloDisponibles) {
               // Si el filtro est√° activo, solo mostramos la muestra verde
               mostrar = estaEnMuestra;
            } else {
               // Si quita el filtro, mostramos la muestra + los ocupados (para que se vea movimiento)
               mostrar = estaEnMuestra || !esDisponible;
            }

          } else {
            // MODO 2: B√öSQUEDA (Cliente escribi√≥ un n√∫mero)
            // Aqu√≠ ignoramos la vitrina y buscamos en TODOS los n√∫meros
            const coincideTexto = numeroDelBoton.includes(busqueda);
            const cumpleEstado = !soloDisponibles || esDisponible;
            
            mostrar = coincideTexto && cumpleEstado;
          }

          btn.style.display = mostrar ? 'flex' : 'none';
        }
      }

      function toggleSeleccion(numero, btn) {
        const index = numerosSeleccionados.indexOf(numero);
        
        if (index === -1) {
          if (numerosSeleccionados.length >= 20) {
            alert("‚ö†Ô∏è L√≠mite alcanzado:\nSolo puedes comprar un m√°ximo de 20 boletas por pedido.");
            return;
          }
          numerosSeleccionados.push(numero);
          btn.classList.add('seleccionado');
        } else {
          numerosSeleccionados.splice(index, 1);
          btn.classList.remove('seleccionado');
        }
        
        actualizarBarra();
      }

      function actualizarBarra() {
        const bar = document.getElementById('bottom-bar');
        const qtyText = document.getElementById('qty-text');
        const totalText = document.getElementById('total-text');

        if (numerosSeleccionados.length > 0) {
          bar.style.display = 'flex';
          qtyText.innerText = numerosSeleccionados.length + (numerosSeleccionados.length === 1 ? " boleta" : " boletas");
          const total = numerosSeleccionados.length * PRECIO_BOLETA;
          totalText.innerText = "$" + total.toLocaleString('es-CO');
        } else {
          bar.style.display = 'none';
        }
      }

      function abrirModal() {
        if (numerosSeleccionados.length === 0) return;
        if (numerosSeleccionados.length < 3) {
          alert("‚ö†Ô∏è COMPRA M√çNIMA:\n\nPara participar, debes adquirir al menos 3 boletas.");
          return;
        }
        document.getElementById('num-modal').innerText = numerosSeleccionados.join(", ");
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('msg-carga').style.display = 'none';
      }

      function cerrarModal() {
        document.getElementById('modal').style.display = 'none';
      }

      function confirmarReserva() {
        // --- AQU√ç EST√Å EL CAMBIO: Agregamos .trim() al final ---
        const nombre = document.getElementById('input-nombre').value.trim();
        // --------------------------------------------------------
        
        const telefono = document.getElementById('input-telefono').value;

        // Validaci√≥n estricta
        if (!nombre || telefono.length !== 10) {
          alert("‚ö†Ô∏è ATENCI√ìN:\n\nPor favor verifica tus datos:\n1. El nombre no puede estar vac√≠o.\n2. El celular debe tener 10 d√≠gitos.");
          return;
        }

        // Mostramos cargando
        document.getElementById('msg-carga').style.display = 'block';
        document.querySelector('.btn-confirmar').disabled = true; 
        
        // --- CAPTURA DE IP ---
        fetch('https://api.ipify.org?format=json')
          .then(response => response.json())
          .then(data => {
             enviarAlServidor(data.ip);
          })
          .catch(error => {
             console.log("No se pudo detectar IP, enviando sin IP.");
             enviarAlServidor("IP_NO_DETECTADA");
          });

        function enviarAlServidor(ip) {
            google.script.run.withSuccessHandler(function(respuesta) {
              if (respuesta.exito) {
                window.top.location.href = respuesta.url;
              } else {
                alert(respuesta.error);
                // Si falla, reactivamos el bot√≥n y ocultamos carga
                document.getElementById('msg-carga').style.display = 'none';
                document.querySelector('.btn-confirmar').disabled = false;
                // Opcional: recargar si prefieres
                // location.reload(); 
              }
            }).reservarNumeros(numerosSeleccionados, nombre, telefono, ip);
        }
      }
      
      function cerrarSoldOut() {
        document.getElementById('modal-soldout').style.display = 'none';
      }

      // --- L√ìGICA DEL OR√ÅCULO IA ---
    
    function abrirOraculo() {
      document.getElementById('modal-oracle').style.display = 'flex';
      document.getElementById('input-oracle-text').focus();
    }

    function cerrarOraculo() {
      document.getElementById('modal-oracle').style.display = 'none';
    }

    function consultarGemini() {
      const texto = document.getElementById('input-oracle-text').value.trim();
      if(texto.length < 3) return alert("Por favor escribe un poco m√°s sobre tu sue√±o.");

      const btn = document.getElementById('btn-ask-oracle');
      const resultBox = document.getElementById('oracle-result');
      const msg = document.getElementById('oracle-msg');
      const suggestions = document.getElementById('oracle-suggestions');

      // Estado Cargando
      btn.disabled = true;
      btn.innerHTML = '‚ú® Consultando...<span class="typing-indicator"></span>';
      resultBox.style.display = 'block';
      msg.innerText = "Conectando con los astros...";
      suggestions.innerHTML = "";

      // LLAMADA AL SERVIDOR (GOOGLE SCRIPT RUN)
      // Ya no hay API KEY aqu√≠. Se llama a la funci√≥n del servidor.
      google.script.run
        .withSuccessHandler(function(rawText) {
            try {
              // Limpiamos la respuesta (quitamos ```json si existe)
              const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
              const interpretacion = JSON.parse(jsonStr);

              msg.innerText = "üîÆ " + interpretacion.mensaje;
              
              interpretacion.numeros.forEach(function(num) {
                  const btnNum = document.createElement('div');
                  btnNum.className = 'btn-oracle-num';
                  btnNum.innerText = num;
                  
                  // ACCI√ìN INTELIGENTE: Busca, Muestra y Selecciona
                  btnNum.onclick = function() {
                     cerrarOraculo();
                     
                     // 1. Usamos el buscador
                     const inputBusqueda = document.getElementById('input-busqueda');
                     inputBusqueda.value = num; 
                     filtrarNumeros(); 

                     // 2. Clic autom√°tico
                     setTimeout(function() {
                       const targetBtn = document.getElementById('btn-' + num);
                       if(targetBtn) {
                          toggleSeleccion(num, targetBtn);
                          targetBtn.scrollIntoView({behavior: "smooth", block: "center"});
                       } else {
                          alert("El or√°culo predijo el " + num + ", pero ya fue vendido.");
                       }
                     }, 100);
                  };
                  suggestions.appendChild(btnNum);
              });
            } catch(e) {
              console.error(e);
              msg.innerText = "El or√°culo habl√≥ en un idioma extra√±o. Intenta de nuevo.";
            }
            // Restaurar bot√≥n
            btn.disabled = false;
            btn.innerHTML = '‚ú® Interpretar Se√±ales';
        })
        .withFailureHandler(function(error) {
            msg.innerText = "Las nubes impiden ver el futuro: " + error.message;
            btn.disabled = false;
            btn.innerHTML = '‚ú® Interpretar Se√±ales';
        })
        .consultarGeminiDesdeServidor(texto);
    }

    </script>
  </body>
</html>